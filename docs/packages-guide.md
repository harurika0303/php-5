# PHP環境 パッケージ解説

このドキュメントでは、Dockerコンテナにインストールされているパッケージについて詳しく解説します。

## 📦 インストールされているパッケージ一覧

### 1. リポジトリ関連

#### `remi-release`
- **目的**: Remiリポジトリの追加
- **必要性**: ⭐⭐⭐⭐⭐ 必須
- **理由**: 
  - AlmaLinux 8の標準リポジトリにはPHP 5.6が含まれていない
  - RemiリポジトリはPHP 5.6を含む古いPHPバージョンを提供する信頼性の高いサードパーティリポジトリ
  - PHP開発者Remi Collet氏が管理する公式リポジトリ

#### `epel-release`
- **目的**: EPEL（Extra Packages for Enterprise Linux）リポジトリの追加
- **必要性**: ⭐⭐⭐⭐ 推奨
- **理由**:
  - RemiリポジトリがEPELの一部のパッケージに依存している
  - 追加の便利なツールやライブラリが利用可能になる

---

### 2. PHP本体とコアパッケージ

#### `php56-php` (メインパッケージ)
- **目的**: PHP 5.6本体
- **必要性**: ⭐⭐⭐⭐⭐ 必須
- **理由**:
  - PHPプログラミング言語の実行環境
  - すべてのPHP機能の基盤
- **サイズ**: 約3MB
- **含まれる機能**:
  - PHP言語のコア機能
  - 基本的な関数群
  - 標準ライブラリ

#### `php56-php-common`
- **目的**: 共通ファイルと設定
- **必要性**: ⭐⭐⭐⭐⭐ 必須（自動インストール）
- **理由**:
  - php56-phpの依存パッケージ
  - 各種PHP拡張モジュールが共通で使用するファイル
  - php.iniなどの設定ファイルを含む

#### `php56-php-cli`
- **目的**: コマンドライン版PHP
- **必要性**: ⭐⭐⭐⭐⭐ 必須（自動インストール）
- **理由**:
  - `php`コマンドでスクリプトを直接実行するために必要
  - バッチ処理やcronジョブで使用
  - デバッグ時に便利

#### `php56-runtime`
- **目的**: PHP実行環境の基盤
- **必要性**: ⭐⭐⭐⭐⭐ 必須（自動インストール）
- **理由**:
  - PHP 5.6のファイル配置やディレクトリ構造を定義
  - 他の全てのphp56パッケージの基礎

---

### 3. PHP-FPM (FastCGI Process Manager)

#### `php56-php-fpm`
- **目的**: PHP FastCGI Process Manager
- **必要性**: ⭐⭐⭐⭐⭐ 必須
- **理由**:
  - Apacheと連携してPHPを高速実行するための仕組み
  - 従来のmod_phpよりもメモリ効率が良い
  - プロセス管理が柔軟で本番環境に適している
- **サイズ**: 約1.5MB

**PHP-FPMの仕組み:**
```
Webブラウザ → Apache → PHP-FPM → PHP処理 → 結果を返す
```

**利点:**
- 各リクエストを独立したプロセスで処理
- メモリリークの影響を最小限に抑える
- プロセス数を動的に調整可能
- Apacheとは別プロセスのため安定性が高い

---

### 4. データベース接続

#### `php56-php-mysqlnd`
- **目的**: MySQL/MariaDB接続用のネイティブドライバー
- **必要性**: ⭐⭐⭐⭐⭐ 必須
- **理由**:
  - MariaDB（MySQL互換データベース）に接続するために必要
  - `mysql_*`、`mysqli_*`、PDO MySQL関数を使用可能にする
  - 「nd」= Native Driver（ネイティブドライバー）の意味
- **サイズ**: 約200KB

**使用できる関数:**
```php
// 古い方式 (非推奨だが動作する)
mysql_connect('db1', 'root', 'root');

// 推奨方式 (mysqli)
$mysqli = new mysqli('db1', 'root', 'root', 'testdb1');

// PDO方式 (最も推奨)
$pdo = new PDO('mysql:host=db1;dbname=testdb1', 'root', 'root');
```

#### `php56-php-pdo`
- **目的**: PDO（PHP Data Objects）拡張
- **必要性**: ⭐⭐⭐⭐⭐ 必須（自動インストール）
- **理由**:
  - データベース接続の統一インターフェース
  - 複数のデータベースを同じコードで扱える
  - プリペアドステートメントでSQLインジェクション対策

---

### 5. 文字列処理

#### `php56-php-mbstring`
- **目的**: マルチバイト文字列処理
- **必要性**: ⭐⭐⭐⭐⭐ 必須（日本語を扱う場合）
- **理由**:
  - 日本語（UTF-8、Shift-JIS、EUC-JP等）の処理に必要
  - 全角・半角の変換
  - 文字エンコーディング変換
  - 文字列の長さ計算（バイト数ではなく文字数）
- **サイズ**: 約1.1MB

**使用できる関数の例:**
```php
mb_strlen('こんにちは');        // 5 (文字数)
mb_convert_encoding($str, 'UTF-8', 'SJIS'); // 文字コード変換
mb_substr('日本語文字列', 0, 3);  // '日本語'
```

---

### 6. 画像処理

#### `php56-php-gd`
- **目的**: GDライブラリ（画像生成・編集）
- **必要性**: ⭐⭐⭐⭐ 推奨（画像を扱う場合）
- **理由**:
  - 画像の生成、リサイズ、トリミング
  - サムネイル作成
  - 透かし（ウォーターマーク）追加
  - グラフやチャートの動的生成
- **サイズ**: 約150KB
- **対応フォーマット**: JPEG、PNG、GIF、WebP

**使用例:**
```php
// 画像のリサイズ
$image = imagecreatefromjpeg('original.jpg');
$resized = imagescale($image, 800, 600);
imagejpeg($resized, 'thumbnail.jpg');

// サムネイル生成
$thumb = imagecreatetruecolor(150, 150);
imagecopyresampled($thumb, $image, 0, 0, 0, 0, 150, 150, 800, 600);
```

**削除した場合の影響:**
- 画像処理機能が使えなくなる
- CMSやECサイトでサムネイル生成ができない
- Captcha（画像認証）が使えない

---

### 7. XML処理

#### `php56-php-xml`
- **目的**: XML関連の処理機能
- **必要性**: ⭐⭐⭐⭐ 推奨
- **理由**:
  - XMLファイルの読み書き
  - SimpleXML、DOM、XMLReader/Writer機能
  - SOAP（Webサービス）通信
  - RSS/Atomフィードの処理
- **サイズ**: 約150KB

**含まれる機能:**
- DOM (Document Object Model)
- SimpleXML
- XML Parser
- XMLReader/XMLWriter

**使用例:**
```php
// XMLの読み込み
$xml = simplexml_load_file('data.xml');
echo $xml->title;

// DOMでXML操作
$dom = new DOMDocument();
$dom->load('data.xml');
```

---

### 8. その他の拡張機能

#### `php56-php-pecl-jsonc`
- **目的**: JSON処理（高速版）
- **必要性**: ⭐⭐⭐⭐⭐ 必須（自動インストール）
- **理由**:
  - APIレスポンスの生成
  - JavaScriptとのデータ交換
  - 設定ファイルの読み書き
- **サイズ**: 約50KB

#### `php56-php-pecl-zip`
- **目的**: ZIP圧縮/展開機能
- **必要性**: ⭐⭐⭐ 任意
- **理由**:
  - ZIPファイルの作成・展開
  - ファイルのダウンロード機能
- **サイズ**: 約70KB

---

### 9. Webサーバー

#### `httpd` (Apache HTTP Server)
- **目的**: Webサーバー
- **必要性**: ⭐⭐⭐⭐⭐ 必須
- **理由**:
  - HTTPリクエストを受け付ける
  - 静的ファイル（HTML、CSS、JavaScript、画像）の配信
  - PHP-FPMと連携してPHPを実行
- **サイズ**: 約2MB
- **バージョン**: Apache 2.4.37

#### `httpd-tools`
- **目的**: Apache管理ツール
- **必要性**: ⭐⭐⭐ 任意（自動インストール）
- **理由**:
  - パスワード暗号化（htpasswd）
  - ログ解析ツール
- **サイズ**: 約100KB

#### `httpd-filesystem`
- **目的**: Apacheのディレクトリ構造
- **必要性**: ⭐⭐⭐⭐⭐ 必須（自動インストール）
- **理由**:
  - Apacheの設定ファイル配置
  - ログディレクトリの作成

---

### 10. ダウンロード・圧縮ツール

#### `curl` (デフォルトでインストール済み)
- **目的**: ファイルのダウンロード
- **必要性**: ⭐⭐⭐ デフォルト
- **理由**:
  - AlmaLinux 8に標準でインストールされている
  - Smartyのダウンロードに使用
  - HTTP/HTTPS通信のデバッグにも便利
- **保持理由**: 将来的に追加パッケージのダウンロードに使用可能

#### `unzip`
- **目的**: ZIPファイルの展開
- **必要性**: ⭐⭐⭐ 保持
- **理由**:
  - Smartyの展開に使用
  - 将来的にZIPファイルを扱う可能性がある
  - コンテナ内での作業時に便利
- **サイズ**: 約200KB
- **保持理由**: 一度使用したツールは残しておく方が実用的

---

## 🎨 Smartyテンプレートエンジン

### Smartyとは
- **目的**: PHPテンプレートエンジン
- **必要性**: ⭐⭐⭐⭐ プロジェクト次第
- **理由**:
  - PHPロジックと表示（HTML）を分離
  - デザイナーとプログラマーの分業がしやすい
  - キャッシュ機能で高速化
- **インストール先**: `/usr/share/php/Smarty`
- **サイズ**: 約2MB

### Smartyの使用例
```php
<?php
require_once '/usr/share/php/Smarty/Smarty.class.php';
$smarty = new Smarty();
$smarty->assign('title', 'ようこそ');
$smarty->display('index.tpl');
```

テンプレート (index.tpl):
```html
<html>
<head><title>{$title}</title></head>
<body>
  <h1>{$title}</h1>
</body>
</html>
```

---

## 📊 パッケージサイズ概算

| カテゴリ | 合計サイズ | 備考 |
|---------|-----------|------|
| PHP本体 | 約5MB | php56-php, common, cli等 |
| PHP拡張 | 約2MB | mbstring, gd, xml, mysqlnd等 |
| Apache | 約3MB | httpd本体と関連ツール |
| Smarty | 約2MB | テンプレートエンジン |
| ツール類 | 約0.2MB | curl(標準), unzip |
| **合計** | **約12MB** | 実用的な構成 |

---

## ⚠️ 削除してはいけないパッケージ

以下のパッケージは削除すると動作しなくなります:

1. **php56-php** - PHP本体
2. **php56-php-fpm** - PHP-FPM（Apacheと連携するため必須）
3. **php56-php-mysqlnd** - データベース接続
4. **php56-php-mbstring** - 日本語処理
5. **httpd** - Webサーバー

---

## ✅ 削除可能なパッケージ

プロジェクトによっては不要な場合があります:

1. **php56-php-gd** - 画像処理が不要なら削除可能
2. **php56-php-xml** - XML/SOAP処理が不要なら削除可能
3. **Smarty** - テンプレートエンジンが不要なら削除可能

削除する場合の影響を理解してから削除してください。

---

## 🔄 最適化済みの構成

現在のDockerfileは以下のように最適化されています:

1. **一時ツールの削除**: wget, unzipをインストール後に削除
2. **キャッシュのクリア**: `dnf clean all`でパッケージキャッシュを削除
3. **最小限の構成**: 必要最小限のパッケージのみインストール

---

## 📝 まとめ

- **必須パッケージ**: 9個（PHP本体、PHP-FPM、データベース接続、文字列処理、Apache）
- **推奨パッケージ**: 3個（画像処理、XML処理、ZIP処理）
- **一時パッケージ**: 2個（インストール後削除済み）
- **総イメージサイズ**: 約12MB（最小構成）

この構成で、日本語を含むWebアプリケーションを動かすための最小限かつ実用的な環境が整います。
